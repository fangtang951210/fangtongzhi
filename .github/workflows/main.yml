# 工作流名字
name: Clear Stock List Every Day

# 触发条件：每天7点（UTC时间，注意时区！如果是北京时间，要写07:00 UTC+8 → 即23:00 UTC，这里先按北京时间7点设置）
on:
  schedule:
    - cron: '0 23 * * *'  # 对应北京时间早上7点（UTC+8，23+8=7）
  workflow_dispatch:  # 手动触发（方便测试）

# 执行的任务
jobs:
  clear-stock-list:
    runs-on: ubuntu-latest
    steps:
      # 第一步：安装Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # 第二步：安装需要的库
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests PyGithub cryptography
      
      # 第三步：运行清空代码
      - name: Clear STOCK_LIST
        env:
          GH_PAT: ${{ secrets.GH_PAT }}  # 读取我们之前加的PAT
          REPO_NAME: "fangtang951210/fangtongzhi"  # 替换成你的
        run: |
          python - <<EOF
          import requests
          from github import Github
          from base64 import b64encode
          from cryptography.hazmat.primitives.asymmetric import padding
          from cryptography.hazmat.primitives import serialization, hashes
          from cryptography.hazmat.backends import default_backend
          import os

          # 获取PAT和仓库名
          gh_token = os.getenv("GH_PAT")
          repo_name = os.getenv("REPO_NAME")

          # 连接GitHub
          g = Github(gh_token)
          repo = g.get_repo(repo_name)

          # 获取仓库的公钥
          headers = {
              "Authorization": f"token {gh_token}",
              "Accept": "application/vnd.github.v3+json"
          }
          pub_key_url = f"https://api.github.com/repos/{repo_name}/actions/secrets/public-key"
          pub_key_res = requests.get(pub_key_url, headers=headers)
          pub_key = pub_key_res.json()["key"]
          pub_key_id = pub_key_res.json()["key_id"]

          # 加密空字符串（清空列表）
          public_key = serialization.load_pem_public_key(
              pub_key.encode(),
              backend=default_backend()
          )
          empty_value = ""
          encrypted_value = public_key.encrypt(
              empty_value.encode(),
              padding.OAEP(
                  mgf=padding.MGF1(algorithm=hashes.SHA256()),
                  algorithm=hashes.SHA256(),
                  label=None
              )
          )
          encrypted_b64 = b64encode(encrypted_value).decode()

          # 更新STOCK_LIST为空
          update_url = f"https://api.github.com/repos/{repo_name}/actions/secrets/STOCK_LIST"
          update_data = {
              "encrypted_value": encrypted_b64,
              "key_id": pub_key_id
          }
          response = requests.put(update_url, json=update_data, headers=headers)
          if response.status_code == 204:
              print("STOCK_LIST已成功清空！")
          else:
              print(f"清空失败：{response.text}")
          EOF
